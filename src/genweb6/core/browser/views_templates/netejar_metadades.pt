<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="here/@@blank_template/macros/master"
      i18n:domain="genweb"
      lang="en">
<body>
<metal:main metal:fill-slot="content">
  <a href="https://www.upc.edu" class="upc-logo">
    <img src="++theme++genweb6.theme/img/logo.png" alt="UPC" class="upc-logo-img" />
  </a>
  <section class="upc-container">
    <div class="upc-card upc-card--centered upc-card--padding">
      <h1 class="upc-heading--large" i18n:translate="heading_metadades">
        Neteja metadades documents
      </h1>

      <form id="upc-form" class="upc-form" action="" method="post" enctype="multipart/form-data" target="download-iframe">
        <div class="upc-form-group">
          <label for="pdf_file" class="upc-label" i18n:translate="select_pdf">
            Selecciona el PDF a netejar:
          </label>
          <input type="file"
                 id="pdf_file"
                 name="pdf_file"
                 accept="application/pdf"
                 required
                 multiple
                 class="upc-input upc-input--file"
                 i18n:attributes="title select_file_button; placeholder no_file_selected" />
        </div>

        <div class="upc-form-group upc-form-group--center">
          <span style="white-space:nowrap;">
            <button type="submit"
                    id="netejar-btn"
                    class="upc-button upc-button--primary"
                    i18n:translate="send_to_anonymize">
              Netejar
            </button>
            <img id="spinner" src="++theme++genweb6.theme/img/spinner.gif"
                 alt="Carregant..." style="display:none; width:64px; height:64px; margin-left:15px; vertical-align:middle;">
          </span>
        </div>

        <p class="upc-text" i18n:translate="neteja_metadades_description">
          Amb aquesta eina pots eliminar fàcilment totes les metadades i la informació oculta dels teus arxius PDF abans de compartir-los, garantint més privacitat i seguretat, i tot amb un sol clic.
          Un cop enviïs els teus documents, es descarregarà automàticament al teu dispositiu el fitxer o fitxers  (en format <strong>.zip</strong>) nets de metadades, llestos per utilitzar.
        </p>
      </form>
      <iframe id="download-iframe" name="download-iframe" style="display:none;"></iframe>
    </div>
    <script type="text/javascript"
            tal:attributes="src string:${context/absolute_url}/++theme++genweb6.theme/js/theme-concat.js"></script>
    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('upc-form');
        var spinner = document.getElementById('spinner');
        var submitBtn = document.getElementById('netejar-btn');
        var fileInput = document.getElementById('pdf_file');
        var downloadIframe = document.getElementById('download-iframe');
        var originalBtnText = submitBtn ? submitBtn.textContent : 'Netejar';
        var alertShown = false;

        function resetForm() {
          // Restaurar texto del botón a "Netejar"
          submitBtn.textContent = originalBtnText;
          
          // Ocultar spinner
          spinner.style.display = 'none';
          
          // Habilitar botón e input
          submitBtn.disabled = false;
          fileInput.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          fileInput.style.opacity = '1';
          fileInput.style.cursor = 'pointer';
          
          alertShown = false;
        }

        if (form && downloadIframe) {
          var safetyTimeout = null;
          
          form.addEventListener('submit', function(e) {
            // Cambiar texto del botón a "Netejant..."
            submitBtn.textContent = 'Netejant...';
            
            // Mostrar spinner
            spinner.style.display = 'inline-block';
            
            // Bloquear botón e input mientras procesa
            submitBtn.disabled = true;
            fileInput.disabled = true;
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'not-allowed';
            fileInput.style.opacity = '0.6';
            fileInput.style.cursor = 'not-allowed';
            
            alertShown = false;
            
            // Timeout de seguridad: SIEMPRE desbloquear después de 30 segundos
            if (safetyTimeout) clearTimeout(safetyTimeout);
            safetyTimeout = setTimeout(function() {
              resetForm();
            }, 30000);
            
            // Después de 5 segundos, mostrar mensaje informativo (pero mantener spinner)
            setTimeout(function() {
              if (!alertShown) {
                alert('El PDF sense metadades es descarregarà en breus. Pot tardar uns minuts');
                alertShown = true;
              }
            }, 5000);
          });
          
          // Detectar cuando el iframe ha terminado de cargar (descarga completada)
          downloadIframe.addEventListener('load', function() {
            // Cancelar el timeout de seguridad si el iframe carga correctamente
            if (safetyTimeout) {
              clearTimeout(safetyTimeout);
              safetyTimeout = null;
            }
            
            // Esperar 5 segundos para asegurar que la descarga está completa
            setTimeout(function() {
              resetForm();
            }, 5000);
          });
        }
      });
    </script>
  </section>
</metal:main>
</body>
</html>
